// Generated by CoffeeScript 1.8.0
var Event, NotificationHelper, async, calendar, fetchCalendar, fetchOnePage, getCalendarId, google, localizationManager, log, notification, oauth2Client, realtimer, _;

async = require('async');

google = require('googleapis');

calendar = google.calendar('v3');

_ = require('lodash');

log = require('printit')({
  prefix: 'calendarimport'
});

Event = require('../models/event');

realtimer = require('./realtimer');

localizationManager = require('./localization_manager');

_ = require('lodash');

oauth2Client = require('./google_access_token').oauth2Client;

NotificationHelper = require('cozy-notifications-helper');

notification = new NotificationHelper('leave-google');

getCalendarId = function(callback) {
  return calendar.calendarList.list({
    auth: oauth2Client
  }, function(err, response) {
    var calendarItem, found, _i, _len, _ref, _ref1, _ref2;
    if (err) {
      return callback(err);
    }
    found = null;
    _ref = response.items;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      calendarItem = _ref[_i];
      if (calendarItem.primary) {
        found = calendarItem.id;
      }
    }
    if (found == null) {
      found = (_ref1 = response.items) != null ? (_ref2 = _ref1[0]) != null ? _ref2.id : void 0 : void 0;
    }
    return callback(null, found);
  });
};

fetchOnePage = function(calendarId, pageToken, callback) {
  var params;
  params = {
    userId: 'me',
    auth: oauth2Client,
    calendarId: calendarId
  };
  if (pageToken !== "nopagetoken") {
    params.pageToken = pageToken;
  }
  log.debug('requesting more events');
  return calendar.events.list(params, function(err, result) {
    if (err) {
      log.debug("error " + err);
      return callback(err);
    } else {
      log.debug("got " + result.items.length + " events");
      return callback(null, result);
    }
  });
};

fetchCalendar = function(calendarId, callback) {
  var calendarEvents, isFinished, numberProcessed, pageToken;
  calendarEvents = [];
  numberProcessed = 0;
  pageToken = "nopagetoken";
  isFinished = function() {
    return (pageToken != null) && pageToken !== "nopagetoken";
  };
  return async.doWhilst(function(next) {
    return fetchOnePage(calendarId, pageToken, function(err, result) {
      calendarEvents = calendarEvents.concat(result.items);
      pageToken = result.nextPageToken;
      return next(null);
    });
  }, isFinished, function(err) {
    if (err) {
      return callback(err);
    }
    log.debug("cozy to create " + calendarEvents.length + " event");
    return callback(null, calendarEvents);
  });
};

module.exports = function(access_token, callback) {
  oauth2Client.setCredentials({
    access_token: access_token
  });
  return getCalendarId(function(err, calendarId) {
    if (err || !calendarId) {
      if (err) {
        log.error(err);
      }
      return callback(new Error('cant get primary calendar'));
    }
    return fetchCalendar(calendarId, function(err, gEvents) {
      var numberProcessed;
      if (err) {
        return callback(err);
      }
      numberProcessed = 0;
      return async.eachSeries(gEvents, function(gEvent, next) {
        var cozyEvent;
        if (!Event.validGoogleEvent(gEvent)) {
          return next(null);
        }
        cozyEvent = Event.fromGoogleEvent(gEvent);
        cozyEvent.tags = ['google calendar'];
        log.debug("cozy create 1 event");
        return Event.createIfNotExist(cozyEvent, function(err) {
          if (err) {
            return callback(err);
          }
          if (err) {
            log.error(err);
          }
          setTimeout(next, 100);
          return realtimer.sendCalendar({
            number: ++numberProcessed,
            total: gEvents.length
          });
        });
      }, function(err) {
        if (err) {
          return callback(err);
        }
        log.info("create notification for events");
        notification.createOrUpdatePersistent("leave-google-calendar", {
          app: 'leave-google',
          text: localizationManager.t('notif_import_event', {
            total: numberProcessed
          }),
          resource: {
            app: 'calendar',
            url: 'calendar/'
          }
        });
        return callback();
      });
    });
  });
};
